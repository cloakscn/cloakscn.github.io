<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="BitTorrent 是一个通过网络下载和分发文件的协议。与传统的客户端/服务器关系相比，下载者连接到中央服务器（例如：在 Netflix 上观看电影，或加载您正在阅读的网页），BitTorrent 网络中的参与者（称为对等点）下载彼此之间的文件片段——这就是它成为点对点协议的原因。我们将研究其工作原理，并构建我们自己的客户端，该客户端可以找到同行并在它们之间交换数据。"><meta name=author content=Cloaks><link href=https://www.cloaks.cn/blog/posts/2024/11/13/ rel=canonical><link href=../../10/16/ rel=prev><link href=../23/ rel=next><link rel=alternate type=application/rss+xml title="RSS 订阅" href=../../../../../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="已更新内容的 RSS 订阅" href=../../../../../feed_rss_updated.xml><link rel=icon href=../../../../../assets/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.1"><title>使用 Go 实现 BitTorrent 客户端 - Cloaks | Return</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.a40c8224.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 13h-4v4h-2v-4H7v-2h4V7h2v4h4m-5-9A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2"/></svg>');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=https://unpkg.com/katex@0/dist/katex.min.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-45SCRDG8S7"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-45SCRDG8S7",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-45SCRDG8S7",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script><meta property=og:type content=website><meta property=og:title content="使用 Go 实现 BitTorrent 客户端 - Cloaks | Return"><meta property=og:description content="BitTorrent 是一个通过网络下载和分发文件的协议。与传统的客户端/服务器关系相比，下载者连接到中央服务器（例如：在 Netflix 上观看电影，或加载您正在阅读的网页），BitTorrent 网络中的参与者（称为对等点）下载彼此之间的文件片段——这就是它成为点对点协议的原因。我们将研究其工作原理，并构建我们自己的客户端，该客户端可以找到同行并在它们之间交换数据。"><meta property=og:image content=https://www.cloaks.cn/assets/images/social/blog/posts/2024/11/13.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://www.cloaks.cn/blog/posts/2024/11/13/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="使用 Go 实现 BitTorrent 客户端 - Cloaks | Return"><meta name=twitter:description content="BitTorrent 是一个通过网络下载和分发文件的协议。与传统的客户端/服务器关系相比，下载者连接到中央服务器（例如：在 Netflix 上观看电影，或加载您正在阅读的网页），BitTorrent 网络中的参与者（称为对等点）下载彼此之间的文件片段——这就是它成为点对点协议的原因。我们将研究其工作原理，并构建我们自己的客户端，该客户端可以找到同行并在它们之间交换数据。"><meta name=twitter:image content=https://www.cloaks.cn/assets/images/social/blog/posts/2024/11/13.png><link href=../../../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#go-bittorrent class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> <aside class=md-banner> <div class="md-banner__inner md-grid md-typeset"> <button class="md-banner__button md-icon" aria-label=不再显示此消息> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> Welcome to <strong>Cloask | Return</strong> Home &nbsp; <a href=https://phpbb.itycu.cn target=_blank rel="noopener noreferrer">PHPBB 社区</a>正式对外开放啦！ </div> <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script> </aside> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../../.. title="Cloaks | Return" class="md-header__button md-logo" aria-label="Cloaks | Return" data-md-component=logo> <img src=../../../../../assets/favicon.ico alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Cloaks | Return </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 使用 Go 实现 BitTorrent 客户端 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/cloakscn/cloakscn.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> cloakscn/cloakscn.github.io </div> </a> </div> </nav> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../../.. class=md-tabs__link> 首页 </a> </li> <li class=md-tabs__item> <a href=../../../../../ruankao/ class=md-tabs__link> 往期精粹 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../../ class=md-tabs__link> 博客 </a> </li> <li class=md-tabs__item> <a href=https://phpbb.itycu.cn class=md-tabs__link> 社区 </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../.. title="Cloaks | Return" class="md-nav__button md-logo" aria-label="Cloaks | Return" data-md-component=logo> <img src=../../../../../assets/favicon.ico alt=logo> </a> Cloaks | Return </label> <div class=md-nav__source> <a href=https://github.com/cloakscn/cloakscn.github.io title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> cloakscn/cloakscn.github.io </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <div class="md-nav__link md-nav__container"> <a href=../../../../.. class="md-nav__link "> <span class=md-ellipsis> 首页 </span> </a> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> 首页 </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> 往期精粹 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 往期精粹 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <div class="md-nav__link md-nav__container"> <a href=../../../../../ruankao/ class="md-nav__link "> <span class=md-ellipsis> 高级架构师 </span> </a> <label class="md-nav__link " for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 高级架构师 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_2> <label class=md-nav__link for=__nav_2_1_2 id=__nav_2_1_2_label tabindex=0> <span class=md-ellipsis> 基础知识 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_2> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20computer/ class=md-nav__link> <span class=md-ellipsis> 计算机系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20embedded/ class=md-nav__link> <span class=md-ellipsis> 嵌入式系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20network/ class=md-nav__link> <span class=md-ellipsis> 计算机网络 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20enterprise-informatization/ class=md-nav__link> <span class=md-ellipsis> 信息系统 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20information%20security/ class=md-nav__link> <span class=md-ellipsis> 信息安全技术 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20system%20engineering/ class=md-nav__link> <span class=md-ellipsis> 系统工程 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20software%20engineering/ class=md-nav__link> <span class=md-ellipsis> 软件工程（重要‼️） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20database-design/ class=md-nav__link> <span class=md-ellipsis> 数据库设计（重要） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/basics%20intellectual%20property%20rights/ class=md-nav__link> <span class=md-ellipsis> 知识产权 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_3> <label class=md-nav__link for=__nav_2_1_3 id=__nav_2_1_3_label tabindex=0> <span class=md-ellipsis> 中级知识 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_3> <span class="md-nav__icon md-icon"></span> 中级知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../ruankao/medium%20software%20architecture/ class=md-nav__link> <span class=md-ellipsis> 系统架构设计（重要） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/medium%20system-quality-attributes-and-architecture-assessment/ class=md-nav__link> <span class=md-ellipsis> 系统质量属性与架构评估（重要） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/medium%20reliability/ class=md-nav__link> <span class=md-ellipsis> 软件可靠性基础 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/medium%20software%20architecture%20evolution/ class=md-nav__link> <span class=md-ellipsis> 软件架构演化和维护 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/medium%20future/ class=md-nav__link> <span class=md-ellipsis> 未来信息综合 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_4> <label class=md-nav__link for=__nav_2_1_4 id=__nav_2_1_4_label tabindex=0> <span class=md-ellipsis> 高级知识 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_4> <span class="md-nav__icon md-icon"></span> 高级知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20information-system-architecture/ class=md-nav__link> <span class=md-ellipsis> 信息系统架构设计理论与实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20hierarchical/ class=md-nav__link> <span class=md-ellipsis> 层次式架构设计理论与实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20cloud-native/ class=md-nav__link> <span class=md-ellipsis> 云原生架构设计理论与实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20service-oriented/ class=md-nav__link> <span class=md-ellipsis> 面向服务架构设计理论与实践（编制中） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20embedded/ class=md-nav__link> <span class=md-ellipsis> 嵌入式系统架构设计理论与实践（编制中） </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20communication%20system/ class=md-nav__link> <span class=md-ellipsis> 通信系统架构设计理论与实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20security%20architecture/ class=md-nav__link> <span class=md-ellipsis> 安全架构设计理论与实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../ruankao/advanced%20web/ class=md-nav__link> <span class=md-ellipsis> Web 应用开发（重要） </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1_5> <label class=md-nav__link for=__nav_2_1_5 id=__nav_2_1_5_label tabindex=0> <span class=md-ellipsis> 论文写作 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1_5> <span class="md-nav__icon md-icon"></span> 论文写作 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../ruankao/paper/ class=md-nav__link> <span class=md-ellipsis> 论文写作（重要） </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <div class="md-nav__link md-nav__container"> <a href=../../../../../design-patterns/ class="md-nav__link "> <span class=md-ellipsis> 设计模式 </span> </a> <label class="md-nav__link " for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 设计模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_2> <label class=md-nav__link for=__nav_2_2_2 id=__nav_2_2_2_label tabindex=0> <span class=md-ellipsis> 创建型模式 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_2> <span class="md-nav__icon md-icon"></span> 创建型模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../design-patterns/creational-patterns/singleton/ class=md-nav__link> <span class=md-ellipsis> 单例模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/creational-patterns/prototype/ class=md-nav__link> <span class=md-ellipsis> 原型模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/creational-patterns/factory/ class=md-nav__link> <span class=md-ellipsis> 工厂模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/creational-patterns/abstract-factory/ class=md-nav__link> <span class=md-ellipsis> 抽象工厂模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_3> <label class=md-nav__link for=__nav_2_2_3 id=__nav_2_2_3_label tabindex=0> <span class=md-ellipsis> 建造者模式 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_3> <span class="md-nav__icon md-icon"></span> 建造者模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/adapter/ class=md-nav__link> <span class=md-ellipsis> 适配器模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/facade/ class=md-nav__link> <span class=md-ellipsis> 外观模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/composite/ class=md-nav__link> <span class=md-ellipsis> 组合模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/proxy/ class=md-nav__link> <span class=md-ellipsis> 代理模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/decorator/ class=md-nav__link> <span class=md-ellipsis> 装饰模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/structural-patterns/bridge/ class=md-nav__link> <span class=md-ellipsis> 桥接模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2_4> <label class=md-nav__link for=__nav_2_2_4 id=__nav_2_2_4_label tabindex=0> <span class=md-ellipsis> 行为模式 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2_4> <span class="md-nav__icon md-icon"></span> 行为模式 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/template-method/ class=md-nav__link> <span class=md-ellipsis> 模版方法模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/state/ class=md-nav__link> <span class=md-ellipsis> 状态模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/strategy/ class=md-nav__link> <span class=md-ellipsis> 策略模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/chain-of-responsibility/ class=md-nav__link> <span class=md-ellipsis> 责任链模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/command/ class=md-nav__link> <span class=md-ellipsis> 命令模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/observer/ class=md-nav__link> <span class=md-ellipsis> 观察者模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/mediator/ class=md-nav__link> <span class=md-ellipsis> 中介者模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/visitor/ class=md-nav__link> <span class=md-ellipsis> 访问者模式 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../design-patterns/behavioral-patterns/iterator/ class=md-nav__link> <span class=md-ellipsis> 迭代器模式 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <div class="md-nav__link md-nav__container"> <a href=../../../../../refactoring/ class="md-nav__link "> <span class=md-ellipsis> 重构 </span> </a> <label class="md-nav__link " for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> 重构 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_2> <label class=md-nav__link for=__nav_2_3_2 id=__nav_2_3_2_label tabindex=0> <span class=md-ellipsis> 什么是重构 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_2> <span class="md-nav__icon md-icon"></span> 什么是重构 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/what-is-refactoring/technical-debt/ class=md-nav__link> <span class=md-ellipsis> 技术债务 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/what-is-refactoring/clean-code/ class=md-nav__link> <span class=md-ellipsis> 干净的代码 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/what-is-refactoring/when/ class=md-nav__link> <span class=md-ellipsis> 何时重构？ </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/what-is-refactoring/how-to/ class=md-nav__link> <span class=md-ellipsis> 如何重构? </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_3> <div class="md-nav__link md-nav__container"> <a href=../../../../../refactoring/code-smells/ class="md-nav__link "> <span class=md-ellipsis> 什么代码需要重构？ </span> </a> <label class="md-nav__link " for=__nav_2_3_3 id=__nav_2_3_3_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_3> <span class="md-nav__icon md-icon"></span> 什么代码需要重构？ </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_3_2> <label class=md-nav__link for=__nav_2_3_3_2 id=__nav_2_3_3_2_label tabindex=0> <span class=md-ellipsis> 臃肿的代码 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_3_2> <span class="md-nav__icon md-icon"></span> 臃肿的代码 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/code-smells/bloaters/long-parameter-list/ class=md-nav__link> <span class=md-ellipsis> 长参数列表 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_3_3> <label class=md-nav__link for=__nav_2_3_3_3 id=__nav_2_3_3_3_label tabindex=0> <span class=md-ellipsis> Dispensables </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_3_3> <span class="md-nav__icon md-icon"></span> Dispensables </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/code-smells/dispensables/data-class/ class=md-nav__link> <span class=md-ellipsis> 数据类 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_4> <div class="md-nav__link md-nav__container"> <a href=../../../../../refactoring/techniques/ class="md-nav__link "> <span class=md-ellipsis> 解决方案 </span> </a> <label class="md-nav__link " for=__nav_2_3_4 id=__nav_2_3_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_2_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_4> <span class="md-nav__icon md-icon"></span> 解决方案 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_4_2> <label class=md-nav__link for=__nav_2_3_4_2 id=__nav_2_3_4_2_label tabindex=0> <span class=md-ellipsis> Composing Methods </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_4_2> <span class="md-nav__icon md-icon"></span> Composing Methods </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/composing-methods/extract-method/ class=md-nav__link> <span class=md-ellipsis> 提取方法 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/composing-methods/replace-temp-with-query/ class=md-nav__link> <span class=md-ellipsis> 使用查询替换临时变量 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/composing-methods/split-temporary-variable/ class=md-nav__link> <span class=md-ellipsis> 拆分临时变量 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_4_3> <label class=md-nav__link for=__nav_2_3_4_3 id=__nav_2_3_4_3_label tabindex=0> <span class=md-ellipsis> Moving Features between Objects </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_4_3> <span class="md-nav__icon md-icon"></span> Moving Features between Objects </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/moving-features-between-objects/move-method/ class=md-nav__link> <span class=md-ellipsis> 移动方法 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_4_4> <label class=md-nav__link for=__nav_2_3_4_4 id=__nav_2_3_4_4_label tabindex=0> <span class=md-ellipsis> Organizing Data </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_4_4> <span class="md-nav__icon md-icon"></span> Organizing Data </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/organizing-data/encapsulate-field/ class=md-nav__link> <span class=md-ellipsis> 封装字段 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/organizing-data/encapsulate-collection/ class=md-nav__link> <span class=md-ellipsis> 封装集合 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3_4_5> <label class=md-nav__link for=__nav_2_3_4_5 id=__nav_2_3_4_5_label tabindex=0> <span class=md-ellipsis> 简化方法调用 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_2_3_4_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3_4_5> <span class="md-nav__icon md-icon"></span> 简化方法调用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/replace-parameter-with-method-call/ class=md-nav__link> <span class=md-ellipsis> 调用方法代替参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/preserve-whole-object/ class=md-nav__link> <span class=md-ellipsis> 保留整个对象 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/remove-parameter/ class=md-nav__link> <span class=md-ellipsis> 删除参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/introduce-parameter-object/ class=md-nav__link> <span class=md-ellipsis> 引入参数对象 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/add-parameter/ class=md-nav__link> <span class=md-ellipsis> 添加参数 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/remove-setting-method/ class=md-nav__link> <span class=md-ellipsis> 删除设置方法 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/hide-method/ class=md-nav__link> <span class=md-ellipsis> 隐藏方法 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/separate-query-from-modifier/ class=md-nav__link> <span class=md-ellipsis> 将查询与修改分开 </span> </a> </li> <li class=md-nav__item> <a href=../../../../../refactoring/techniques/simplifying-method-calls/rename-method/ class=md-nav__link> <span class=md-ellipsis> 重命名方法 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__container"> <a href=../../../../ class="md-nav__link "> <span class=md-ellipsis> 博客 </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 博客 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2023/ class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> <li class=md-nav__item> <a href=../../../../archive/2022/ class=md-nav__link> <span class=md-ellipsis> 2022 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> 分类 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 分类 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../category/build-your-own-database/ class=md-nav__link> <span class=md-ellipsis> Build your own database </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/clash-%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3/ class=md-nav__link> <span class=md-ellipsis> Clash 源码详解 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/golang-%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Golang 编程实践 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/linux/ class=md-nav__link> <span class=md-ellipsis> Linux </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/qa/ class=md-nav__link> <span class=md-ellipsis> Q&amp;A </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E5%8C%BA%E5%9D%97%E9%93%BE/ class=md-nav__link> <span class=md-ellipsis> 区块链 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/ class=md-nav__link> <span class=md-ellipsis> 数据分析 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E6%9C%AD%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> 札记 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E7%82%92%E8%82%A1%E5%85%BB%E5%AE%B6/ class=md-nav__link> <span class=md-ellipsis> 炒股养家 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E7%AE%97%E6%B3%95/ class=md-nav__link> <span class=md-ellipsis> 算法 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ class=md-nav__link> <span class=md-ellipsis> 读书笔记 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 软件工程 </span> </a> </li> <li class=md-nav__item> <a href=../../../../category/%E9%AB%98%E7%BA%A7%E6%9E%B6%E6%9E%84%E5%B8%88/ class=md-nav__link> <span class=md-ellipsis> 高级架构师 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://phpbb.itycu.cn class=md-nav__link> <span class=md-ellipsis> 社区 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 寻找对等网络 </span> </a> <nav class=md-nav aria-label=寻找对等网络> <ul class=md-nav__list> <li class=md-nav__item> <a href=#torrent class=md-nav__link> <span class=md-ellipsis> 解析 .torrent 文件 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 从跟踪器检索对等点 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 解析跟踪器响应 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 从对等网络中下载 </span> </a> <nav class=md-nav aria-label=从对等网络中下载> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tcp class=md-nav__link> <span class=md-ellipsis> 建立 TCP 连接 </span> </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 完成握手 </span> </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 发送和接收消息 </span> </a> <nav class=md-nav aria-label=发送和接收消息> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 解释消息 </span> </a> </li> <li class=md-nav__item> <a href=#bit class=md-nav__link> <span class=md-ellipsis> Bit 字段 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 将所有的内容整合到一起 </span> </a> <nav class=md-nav aria-label=将所有的内容整合到一起> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 管理并发性：作为队列的通道 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 管理状态 </span> </a> </li> <li class=md-nav__item> <a href=#time-to-make-requests class=md-nav__link> <span class=md-ellipsis> Time to make requests! </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 流水线 </span> </a> </li> <li class=md-nav__item> <a href=#maingo class=md-nav__link> <span class=md-ellipsis> main.go </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 这并不是故事的全部 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=../../../../ class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> 回到主页 </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=../../../../../assets/avatar.jpg alt=Cloaks> </span> <span class=md-profile__description> <strong> Cloaks </strong> <br> Keep running, keep growing! </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> 元数据 </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2024-11-13 00:00:00+00:00" class=md-ellipsis>2024年11月13日</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9 3v15h3V3zm3 2 4 13 3-1-4-13zM5 5v13h3V5zM3 19v2h18v-2z"/></svg> <span class=md-ellipsis> 分类于 <a href=../../../../category/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/ >读书笔记</a></span> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 需要 9 分钟阅读时间 </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <nav class=md-tags> <span class=md-tag>翻译</span> </nav> <a href=https://github.com/cloakscn/cloakscn.github.io/edit/master/docs/blog/posts/2024/11/13.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/cloakscn/cloakscn.github.io/raw/master/docs/blog/posts/2024/11/13.md title=查看本页的源代码 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=go-bittorrent>使用 Go 实现 BitTorrent 客户端</h1> <blockquote> <p>原文地址：<a href=https://blog.jse.li/posts/torrent/ >https://blog.jse.li/posts/torrent/</a></p> </blockquote> <p>BitTorrent 是一个通过网络下载和分发文件的协议。与传统的客户端/服务器关系相比，下载者连接到中央服务器（例如：在 Netflix 上观看电影，或加载您正在阅读的网页），BitTorrent 网络中的参与者（称为对等点）下载彼此之间的文件片段——这就是它成为点对点协议的原因。我们将研究其工作原理，并构建我们自己的客户端，该客户端可以找到同行并在它们之间交换数据。</p> <p><a class=glightbox href=../../../../2024/11/images/image.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image.png></a></p> <!-- more --> <h2 id=_1>寻找对等网络</h2> <p>这里有一个问题：我们想用 BitTorrent 下载一个文件，但它是一个点对点协议，我们不知道在哪里可以找到对等点来下载它。这很像搬到一个新城市并试图结交朋友——也许我们会去当地的酒吧或聚会小组！</p> <p>像这样的集中位置是跟踪器背后的重要理念，跟踪器是相互介绍对等点的中央服务器。它们只是通过 HTTP* 运行的 Web 服务器，您可以在 <a href=http://bttracker.debian.org:6969/ >http://bttracker.debian.org:6969/</a> 找到 Debian。</p> <p><a class=glightbox href=../../../../2024/11/images/image-1.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-1.png></a></p> <p>当然，如果这些中央服务器促进同行交换非法内容，它们很可能会受到联邦政府的袭击。您可能还记得读过有关 TorrentSpy、Popcorn Time 和 KickassTorrents 等跟踪器被查封和关闭的信息。新方法通过使对等发现成为一个分布式过程来消除中间人。我们不会实施它们，但如果您有兴趣，您可以研究一些术语，包括 DHT、PEX 和磁力链接。</p> <h3 id=torrent>解析 .torrent 文件</h3> <p>.torrent 文件描述了 torrent 文件的内容以及用于连接到跟踪器的信息。这就是我们启动 torrent 下载过程所需要的一切。 Debian 的 .torrent 文件如下所示：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:&quot;Debian CD from cdimage.debian.org&quot;13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:�����PS�^�� (binary blob of the hashes of each piece)ee
</span></code></pre></div> <p>这些混乱的内容以一种名为 Bencode（发音为 bee-encode）的格式进行编码，我们需要对其进行解码。</p> <p>Bencode 可以编码与 JSON 大致相同类型的结构：字符串、整数、列表和字典。 Bencoded 数据不像 JSON 那样人类可读/可写，但它可以有效地处理二进制数据，并且从流中解析非常简单。字符串带有长度前缀，看起来像 4:spam。整数位于开始标记和结束标记之间，因此 7 将编码为 i7e。列表和字典的工作方式类似：l4:spami7ee 表示 ['spam', 7]，而 d4:spami7ee 表示 {spam: 7}。</p> <p>在更漂亮的格式中，我们的 .torrent 文件如下所示：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>d
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>  8:announce
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>    41:http://bttracker.debian.org:6969/announce
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>  7:comment
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>    35:&quot;Debian CD from cdimage.debian.org&quot;
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>  13:creation date
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>    i1573903810e
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>  4:info
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    d
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>      6:length
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        i351272960e
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>      4:name
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>        31:debian-10.2.0-amd64-netinst.iso
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>      12:piece length
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        i262144e
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>      6:pieces
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>        26800:�����PS�^�� (binary blob of the hashes of each piece)
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    e
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>e
</span></code></pre></div> <p>在这个文件中，我们可以发现跟踪器的 URL、创建日期（作为 Unix 时间戳）、文件的名称和大小，以及包含每个片段的 SHA-1 哈希值的大二进制 blob，它们同样是：我们要下载的文件的大小部分。每个种子文件的确切大小各不相同，但通常在 256KB 到 1MB 之间。这意味着一个大文件可能由数千个部分组成。我们将从同行那里下载这些片段，根据我们的 torrent 文件中的哈希值检查它们，将它们组装在一起，然后，我们就得到了一个文件！</p> <p><a class=glightbox href=../../../../2024/11/images/image-2.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-2.png></a></p> <p>这种机制使我们能够在进行过程中验证每个部分的完整性。它使 BitTorrent 能够抵御意外损坏或故意 torrent 中毒。除非攻击者能够通过原像攻击破坏 SHA-1，否则我们将准确获得我们所要求的内容。</p> <p>编写一个 Bencode 解析器真的很有趣，但解析不是我们今天的重点。但我发现 Fredrik Lundh 的 50 行解析器特别具有启发性。对于这个项目，我使用了 github.com/jackpal/bencode-go：</p> <div class="language-go highlight"><span class=filename>bencode.go</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>import</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=s>&quot;github.com/jackpal/bencode-go&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=p>)</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=kd>type</span><span class=w> </span><span class=nx>bencodeInfo</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=nx>Pieces</span><span class=w>      </span><span class=kt>string</span><span class=w> </span><span class=s>`bencode:&quot;pieces&quot;`</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=nx>PieceLength</span><span class=w> </span><span class=kt>int</span><span class=w>    </span><span class=s>`bencode:&quot;piece length&quot;`</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=nx>Length</span><span class=w>      </span><span class=kt>int</span><span class=w>    </span><span class=s>`bencode:&quot;length&quot;`</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=nx>Name</span><span class=w>        </span><span class=kt>string</span><span class=w> </span><span class=s>`bencode:&quot;name&quot;`</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=p>}</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=kd>type</span><span class=w> </span><span class=nx>bencodeTorrent</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>    </span><span class=nx>Announce</span><span class=w> </span><span class=kt>string</span><span class=w>      </span><span class=s>`bencode:&quot;announce&quot;`</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>    </span><span class=nx>Info</span><span class=w>     </span><span class=nx>bencodeInfo</span><span class=w> </span><span class=s>`bencode:&quot;info&quot;`</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=p>}</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=c1>// Open parses a torrent file</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=kd>func</span><span class=w> </span><span class=nx>Open</span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>bencodeTorrent</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>    </span><span class=nx>bto</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>bencodeTorrent</span><span class=p>{}</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>bencode</span><span class=p>.</span><span class=nx>Unmarshal</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=nx>bto</span><span class=p>)</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>bto</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=p>}</span>
</span></code></pre></div> <p>因为我喜欢保持结构相对平坦，并且喜欢将应用程序结构与序列化结构分开，所以我导出了一个不同的、更平坦的结构，名为 TorrentFile，并编写了一些辅助函数来在两者之间进行转换。</p> <p>值得注意的是，我将片段（以前是字符串）分割成哈希值片段（每个 [20] 字节），以便稍后可以轻松访问各个哈希值。我还计算了整个编码信息字典（包含名称、大小和片段哈希值的字典）的 SHA-1 哈希值。我们将其称为 infohash，当我们与跟踪器和对等点对话时，它唯一地标识文件。稍后会详细介绍这一点。</p> <p><a class=glightbox href=../../../../2024/11/images/image-3.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-3.png></a></p> <div class="language-go highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kd>type</span><span class=w> </span><span class=nx>TorrentFile</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=nx>Announce</span><span class=w>    </span><span class=kt>string</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=nx>InfoHash</span><span class=w>    </span><span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span><span class=nx>PieceHashes</span><span class=w> </span><span class=p>[][</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>    </span><span class=nx>PieceLength</span><span class=w> </span><span class=kt>int</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>    </span><span class=nx>Length</span><span class=w>      </span><span class=kt>int</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>    </span><span class=nx>Name</span><span class=w>        </span><span class=kt>string</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=p>}</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>bto</span><span class=w> </span><span class=nx>bencodeTorrent</span><span class=p>)</span><span class=w> </span><span class=nx>toTorrentFile</span><span class=p>()</span><span class=w> </span><span class=p>(</span><span class=nx>TorrentFile</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=c1>// …</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=p>}</span>
</span></code></pre></div> <h3 id=_2>从跟踪器检索对等点</h3> <p>现在我们有了有关文件及其跟踪器的信息，让我们与跟踪器交谈以宣布我们作为对等点的存在并检索其他对等点的列表。我们只需要向 .torrent 文件中提供的公告 URL 发出 GET 请求，并带有一些查询参数：</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>TorrentFile</span><span class=p>)</span><span class=w> </span><span class=nx>buildTrackerURL</span><span class=p>(</span><span class=nx>peerID</span><span class=w> </span><span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>port</span><span class=w> </span><span class=kt>uint16</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=nx>base</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nx>Parse</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>Announce</span><span class=p>)</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>    </span><span class=nx>params</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nx>Values</span><span class=p>{</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=s>&quot;info_hash&quot;</span><span class=p>:</span><span class=w>  </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nb>string</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>InfoHash</span><span class=p>[:])},</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>        </span><span class=s>&quot;peer_id&quot;</span><span class=p>:</span><span class=w>    </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nb>string</span><span class=p>(</span><span class=nx>peerID</span><span class=p>[:])},</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>        </span><span class=s>&quot;port&quot;</span><span class=p>:</span><span class=w>       </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>strconv</span><span class=p>.</span><span class=nx>Itoa</span><span class=p>(</span><span class=nb>int</span><span class=p>(</span><span class=nx>Port</span><span class=p>))},</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class=s>&quot;uploaded&quot;</span><span class=p>:</span><span class=w>   </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&quot;0&quot;</span><span class=p>},</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>        </span><span class=s>&quot;downloaded&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&quot;0&quot;</span><span class=p>},</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>        </span><span class=s>&quot;compact&quot;</span><span class=p>:</span><span class=w>    </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&quot;1&quot;</span><span class=p>},</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>        </span><span class=s>&quot;left&quot;</span><span class=p>:</span><span class=w>       </span><span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>strconv</span><span class=p>.</span><span class=nx>Itoa</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>Length</span><span class=p>)},</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>    </span><span class=nx>base</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>params</span><span class=p>.</span><span class=nx>Encode</span><span class=p>()</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>base</span><span class=p>.</span><span class=nx>String</span><span class=p>(),</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=p>}</span>
</span></code></pre></div> <p>重要的：</p> <ul> <li> <p>info_hash：标识我们尝试下载的文件。这是我们之前根据编码后的信息字典计算出的信息哈希值。跟踪器将使用它来确定要向我们展示哪些对等点。</p> </li> <li> <p>peer_id：一个 20 字节的名称，用于向跟踪器和对等点标识我们自己。我们将为此生成 20 个随机字节。真正的 BitTorrent 客户端具有类似 -TR2940-k8hj0wgej6ch 的 ID，用于标识客户端软件和版本 - 在本例中，TR2940 代表 Transmission 客户端 2.94。</p> </li> </ul> <p><a class=glightbox href=../../../../2024/11/images/image-4.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-4.png></a></p> <h3 id=_3>解析跟踪器响应</h3> <p>我们收到一个编码响应：</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>d
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>  8:interval
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    i900e
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>  5:peers
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    252:(another long binary blob)
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>e
</span></code></pre></div> <p>Interval 告诉我们应该多久再次连接到跟踪器以刷新我们的对等点列表。值 900 意味着我们应该每 15 分钟（900 秒）重新连接一次。</p> <p>Peers 是另一个长二进制 blob，包含每个对等点的 IP 地址。它由六个字节组成。每组中的前四个字节代表对等方的 IP 地址，每个字节代表 IP 中的一个数字。最后两个字节表示端口，为 big-endian uint16。 Big-endian（或网络顺序）意味着我们可以通过将一组字节从左到右压缩在一起来将它们解释为整数。例如，字节 0x1A、0xE1 构成十进制的 0x1AE1 或 6881。*</p> <p><a class=glightbox href=../../../../2024/11/images/image-5.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-5.png></a></p> <div class="language-go highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=c1>// Peer encodes connection information for a peer</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kd>type</span><span class=w> </span><span class=nx>Peer</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=nx>IP</span><span class=w>   </span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=nx>Port</span><span class=w> </span><span class=kt>uint16</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=p>}</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=c1>// Unmarshal parses peer IP addresses and ports from a buffer</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=kd>func</span><span class=w> </span><span class=nx>Unmarshal</span><span class=p>(</span><span class=nx>peersBin</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=nx>Peer</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>    </span><span class=kd>const</span><span class=w> </span><span class=nx>peerSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=c1>// 4 for IP, 2 for port</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>    </span><span class=nx>numPeers</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>peersBin</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=nx>peerSize</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>peersBin</span><span class=p>)</span><span class=o>%</span><span class=nx>peerSize</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nx>Errorf</span><span class=p>(</span><span class=s>&quot;Received malformed peers&quot;</span><span class=p>)</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>    </span><span class=nx>peers</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=nx>Peer</span><span class=p>,</span><span class=w> </span><span class=nx>numPeers</span><span class=p>)</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>numPeers</span><span class=p>;</span><span class=w> </span><span class=nx>i</span><span class=o>++</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>        </span><span class=nx>offset</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>i</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>peerSize</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>        </span><span class=nx>peers</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>IP</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span><span class=p>(</span><span class=nx>peersBin</span><span class=p>[</span><span class=nx>offset</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=nx>offset</span><span class=o>+</span><span class=mi>4</span><span class=p>])</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>        </span><span class=nx>peers</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Port</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>binary</span><span class=p>.</span><span class=nx>BigEndian</span><span class=p>.</span><span class=nx>Uint16</span><span class=p>(</span><span class=nx>peersBin</span><span class=p>[</span><span class=nx>offset</span><span class=o>+</span><span class=mi>4</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=nx>offset</span><span class=o>+</span><span class=mi>6</span><span class=p>])</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>peers</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=p>}</span>
</span></code></pre></div> <h2 id=_4>从对等网络中下载</h2> <p>现在我们有了一个同行列表，是时候与他们联系并开始下载作品了！我们可以将这个过程分解为几个步骤。对于每个同行，我们希望：</p> <ol> <li>启动与对等方的 TCP 连接。这就像拨打电话一样。</li> <li>完成双向 BitTorrent 握手。 “你好？” “你好。”</li> <li>交换消息以下载片段。 “我想要第 231 号作品。”</li> </ol> <h3 id=tcp>建立 TCP 连接</h3> <div class="language-go highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>net</span><span class=p>.</span><span class=nx>DialTimeout</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>peer</span><span class=p>.</span><span class=nx>String</span><span class=p>(),</span><span class=w> </span><span class=mi>3</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=p>}</span>
</span></code></pre></div> <p>我设置了一个超时，这样我就不会在不允许我连接的同伴身上浪费太多时间。在大多数情况下，这是一个非常标准的 TCP 连接。</p> <h3 id=_5>完成握手</h3> <p>我们刚刚与对等方建立了连接，但我们想要握手来验证我们对对等方的假设</p> <ol> <li>可以使用 BitTorrent 协议进行通信</li> <li>能够理解并回复我们的消息</li> <li>有我们想要的文件，或者至少知道我们在说什么</li> </ol> <p><a class=glightbox href=../../../../2024/11/images/image-6.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-6.png></a></p> <p>我父亲告诉我，良好握手的秘诀是握紧和目光接触。良好的 BitTorrent 握手的秘诀在于它由五个部分组成：</p> <ol> <li>协议标识符的长度，始终为 19（十六进制为 0x13）</li> <li>协议标识符，称为 pstr，始终是 BitTorrent 协议</li> <li>八个保留字节，全部设置为 0。我们将其中一些翻转为 1，以表明我们支持某些扩展。但我们不这样做，所以我们将它们保持为 0。</li> <li>我们之前计算的 infohash 用于识别我们想要的文件</li> <li>我们编写的用于识别自己身份的 Peer ID</li> </ol> <p>放在一起，握手字符串可能如下所示：</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=se>\x</span>13BitTorrent<span class=w> </span>protocol<span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>86</span><span class=se>\x</span>d4<span class=se>\x</span>c8<span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>24</span><span class=se>\x</span>a4<span class=se>\x</span><span class=m>69</span><span class=se>\x</span>be<span class=se>\x</span>4c<span class=se>\x</span><span class=m>50</span><span class=se>\x</span>bc<span class=se>\x</span>5a<span class=se>\x</span><span class=m>10</span><span class=se>\x</span>2c<span class=se>\x</span>f7<span class=se>\x</span><span class=m>17</span><span class=se>\x</span><span class=m>80</span><span class=se>\x</span><span class=m>31</span><span class=se>\x</span><span class=m>00</span><span class=se>\x</span><span class=m>74</span>-TR2940-k8hj0wgej6ch
</span></code></pre></div> <p>在我们向对等方发送握手信号后，我们应该收到以相同格式返回的握手信号。我们返回的信息哈希值应该与我们发送的信息哈希值相匹配，这样我们就知道我们正在谈论同一个文件。如果一切按计划进行，我们就可以出发了。如果没有，我们可以切断连接，因为出现了问题。 “你好？” “这是谁？你想要什么？”“好吧，哇，号码打错了。”</p> <p>在我们的代码中，让我们创建一个结构体来表示握手，并编写一些用于序列化和读取它们的方法：</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1>// A Handshake is a special message that a peer uses to identify itself</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=kd>type</span><span class=w> </span><span class=nx>Handshake</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>    </span><span class=nx>Pstr</span><span class=w>     </span><span class=kt>string</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>    </span><span class=nx>InfoHash</span><span class=w> </span><span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>    </span><span class=nx>PeerID</span><span class=w>   </span><span class=p>[</span><span class=mi>20</span><span class=p>]</span><span class=kt>byte</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=p>}</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=c1>// Serialize serializes the handshake to a buffer</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>h</span><span class=w> </span><span class=o>*</span><span class=nx>Handshake</span><span class=p>)</span><span class=w> </span><span class=nx>Serialize</span><span class=p>()</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>    </span><span class=nx>buf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>Pstr</span><span class=p>)</span><span class=o>+</span><span class=mi>49</span><span class=p>)</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>    </span><span class=nx>buf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>byte</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>Pstr</span><span class=p>))</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>    </span><span class=nx>curr</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>    </span><span class=nx>curr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=nx>curr</span><span class=p>:],</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>Pstr</span><span class=p>)</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>    </span><span class=nx>curr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=nx>curr</span><span class=p>:],</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>))</span><span class=w> </span><span class=c1>// 8 reserved bytes</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>    </span><span class=nx>curr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=nx>curr</span><span class=p>:],</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>InfoHash</span><span class=p>[:])</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>    </span><span class=nx>curr</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=nx>curr</span><span class=p>:],</span><span class=w> </span><span class=nx>h</span><span class=p>.</span><span class=nx>PeerID</span><span class=p>[:])</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>buf</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=p>}</span>
</span><span id=__span-9-19><a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>
</span><span id=__span-9-20><a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=c1>// Read parses a handshake from a stream</span>
</span><span id=__span-9-21><a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=kd>func</span><span class=w> </span><span class=nx>Read</span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Handshake</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-9-22><a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=w>    </span><span class=c1>// Do Serialize(), but backwards</span>
</span><span id=__span-9-23><a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a><span class=w>    </span><span class=c1>// ...</span>
</span><span id=__span-9-24><a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a><span class=p>}</span>
</span></code></pre></div> <h3 id=_6>发送和接收消息</h3> <p>完成初始握手后，我们就可以发送和接收消息。好吧，不完全是——如果另一个对等方还没有准备好接受消息，我们就无法发送任何消息，直到他们告诉我们他们准备好了。在这种状态下，我们被认为是被对方窒息了。他们会向我们发送一条畅通无阻的消息，让我们知道我们可以开始向他们索要数据。默认情况下，我们假设自己被窒息了，直到事实证明并非如此。</p> <p>一旦我们被解除阻塞，我们就可以开始发送对碎片的请求，他们可以向我们发送包含碎片的消息。</p> <p><a class=glightbox href=../../../../2024/11/images/image-7.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-7.png></a></p> <h4 id=_7>解释消息</h4> <p>消息具有长度、ID 和有效负载。在电线上，它看起来像：</p> <p><a class=glightbox href=../../../../2024/11/images/image-8.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-8.png></a></p> <p>消息以长度指示符开头，它告诉我们消息的长度为多少字节。它是一个 32 位整数，这意味着它由按大端顺序混合在一起的四个字节组成。下一个字节，即 ID，告诉我们正在接收哪种类型的消息，例如，2 个字节表示“感兴趣”。最后，可选的有效负载填充消息的剩余长度。</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kd>type</span><span class=w> </span><span class=nx>messageID</span><span class=w> </span><span class=kt>uint8</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=kd>const</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=nx>MsgChoke</span><span class=w>         </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=nx>MsgUnchoke</span><span class=w>       </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=nx>MsgInterested</span><span class=w>    </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>2</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>    </span><span class=nx>MsgNotInterested</span><span class=w> </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>3</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span><span class=nx>MsgHave</span><span class=w>          </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>4</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>    </span><span class=nx>MsgBitfield</span><span class=w>      </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>5</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=nx>MsgRequest</span><span class=w>       </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>6</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=w>    </span><span class=nx>MsgPiece</span><span class=w>         </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>7</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>    </span><span class=nx>MsgCancel</span><span class=w>        </span><span class=nx>messageID</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>8</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=p>)</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=c1>// Message stores ID and payload of a message</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=kd>type</span><span class=w> </span><span class=nx>Message</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>    </span><span class=nx>ID</span><span class=w>      </span><span class=nx>messageID</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=w>    </span><span class=nx>Payload</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=p>}</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=c1>// Serialize serializes a message into a buffer of the form</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=c1>// &lt;length prefix&gt;&lt;message ID&gt;&lt;payload&gt;</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a><span class=c1>// Interprets `nil` as a keep-alive message</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>m</span><span class=w> </span><span class=o>*</span><span class=nx>Message</span><span class=p>)</span><span class=w> </span><span class=nx>Serialize</span><span class=p>()</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>m</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-10-27><a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-10-28><a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a><span class=w>    </span><span class=nx>length</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>uint32</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>Payload</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=c1>// +1 for id</span>
</span><span id=__span-10-29><a id=__codelineno-10-29 name=__codelineno-10-29 href=#__codelineno-10-29></a><span class=w>    </span><span class=nx>buf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=o>+</span><span class=nx>length</span><span class=p>)</span>
</span><span id=__span-10-30><a id=__codelineno-10-30 name=__codelineno-10-30 href=#__codelineno-10-30></a><span class=w>    </span><span class=nx>binary</span><span class=p>.</span><span class=nx>BigEndian</span><span class=p>.</span><span class=nx>PutUint32</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=mi>4</span><span class=p>],</span><span class=w> </span><span class=nx>length</span><span class=p>)</span>
</span><span id=__span-10-31><a id=__codelineno-10-31 name=__codelineno-10-31 href=#__codelineno-10-31></a><span class=w>    </span><span class=nx>buf</span><span class=p>[</span><span class=mi>4</span><span class=p>]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>byte</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>ID</span><span class=p>)</span>
</span><span id=__span-10-32><a id=__codelineno-10-32 name=__codelineno-10-32 href=#__codelineno-10-32></a><span class=w>    </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=mi>5</span><span class=p>:],</span><span class=w> </span><span class=nx>m</span><span class=p>.</span><span class=nx>Payload</span><span class=p>)</span>
</span><span id=__span-10-33><a id=__codelineno-10-33 name=__codelineno-10-33 href=#__codelineno-10-33></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>buf</span>
</span><span id=__span-10-34><a id=__codelineno-10-34 name=__codelineno-10-34 href=#__codelineno-10-34></a><span class=p>}</span>
</span></code></pre></div> <p>要从流中读取消息，我们只需遵循消息的格式即可。我们读取四个字节并将它们解释为 uint32 以获取消息的长度。然后，我们读取该字节数以获取 ID（第一个字节）和有效负载（剩余字节）。</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1>// Read parses a message from a stream. Returns `nil` on keep-alive message</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kd>func</span><span class=w> </span><span class=nx>Read</span><span class=p>(</span><span class=nx>r</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Message</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=nx>lengthBuf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>)</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>ReadFull</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=nx>lengthBuf</span><span class=p>)</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>    </span><span class=nx>length</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>binary</span><span class=p>.</span><span class=nx>BigEndian</span><span class=p>.</span><span class=nx>Uint32</span><span class=p>(</span><span class=nx>lengthBuf</span><span class=p>)</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=c1>// keep-alive message</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=nx>messageBuf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>length</span><span class=p>)</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>ReadFull</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span><span class=w> </span><span class=nx>messageBuf</span><span class=p>)</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>    </span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>Message</span><span class=p>{</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>        </span><span class=nx>ID</span><span class=p>:</span><span class=w>      </span><span class=nx>messageID</span><span class=p>(</span><span class=nx>messageBuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>        </span><span class=nx>Payload</span><span class=p>:</span><span class=w> </span><span class=nx>messageBuf</span><span class=p>[</span><span class=mi>1</span><span class=p>:],</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>m</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=p>}</span>
</span></code></pre></div> <h4 id=bit>Bit 字段</h4> <p>比特字段是最有趣的信息类型之一，它是一种数据结构，同行可以用它来有效地编码他们能够发送给我们的棋子。比特字段看起来就像一个字节数组，我们只需查看设置为 1 的比特的位置，就能知道他们有哪些信息。我们从一张全为 0 的空白卡开始，然后将比特位翻转为 1，将其位置标记为 “已盖章”。</p> <p><a class=glightbox href=../../../../2024/11/images/image-9.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-9.png></a></p> <p>通过使用比特而不是字节，这种数据结构超级紧凑。我们可以在一个字节（一个 bool 的大小）的空间内塞入八个片段的信息。但这样做的代价是，访问数值变得有点麻烦。计算机能寻址的最小内存单位是字节，因此要访问比特，我们必须进行一些比特操作：</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=c1>// A Bitfield represents the pieces that a peer has</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=kd>type</span><span class=w> </span><span class=nx>Bitfield</span><span class=w> </span><span class=p>[]</span><span class=kt>byte</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=c1>// HasPiece tells if a bitfield has a particular index set</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>bf</span><span class=w> </span><span class=nx>Bitfield</span><span class=p>)</span><span class=w> </span><span class=nx>HasPiece</span><span class=p>(</span><span class=nx>index</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a><span class=w>    </span><span class=nx>byteIndex</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>index</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>8</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=w>    </span><span class=nx>offset</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>index</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>8</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>bf</span><span class=p>[</span><span class=nx>byteIndex</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=mi>7</span><span class=o>-</span><span class=nx>offset</span><span class=p>)</span><span class=o>&amp;</span><span class=mi>1</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a><span class=p>}</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a><span class=c1>// SetPiece sets a bit in the bitfield</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>bf</span><span class=w> </span><span class=nx>Bitfield</span><span class=p>)</span><span class=w> </span><span class=nx>SetPiece</span><span class=p>(</span><span class=nx>index</span><span class=w> </span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a><span class=w>    </span><span class=nx>byteIndex</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>index</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>8</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=w>    </span><span class=nx>offset</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>index</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=mi>8</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a><span class=w>    </span><span class=nx>bf</span><span class=p>[</span><span class=nx>byteIndex</span><span class=p>]</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=p>(</span><span class=mi>7</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>offset</span><span class=p>)</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=p>}</span>
</span></code></pre></div> <h3 id=_8>将所有的内容整合到一起</h3> <p>现在，我们已经拥有了下载洪流所需的所有工具：我们有了从跟踪器获取的对等点列表，可以通过拨号 TCP 连接、启动握手以及发送和接收消息与它们通信。我们的最后一个大问题是处理同时与多个对等体通信所涉及的并发问题，以及在与对等体交互时管理对等体的状态。这些都是经典的硬件问题。</p> <h4 id=_9>管理并发性：作为队列的通道</h4> <p>在 Go 中，我们通过通信来共享内存，我们可以将 Go 通道视为廉价的线程安全队列。</p> <p>我们将设置两个通道来同步我们的并发工作者：一个用于在对等程序之间分配工作（下载文件），另一个用于收集下载的文件。当下载的片段通过结果通道进入时，我们就可以将它们复制到缓冲区，开始组装我们的完整文件。</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=c1>// Init queues for workers to retrieve work and send results</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=nx>workQueue</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>pieceWork</span><span class=p>,</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>PieceHashes</span><span class=p>))</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=nx>results</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>pieceResult</span><span class=p>)</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=k>for</span><span class=w> </span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>hash</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>PieceHashes</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>    </span><span class=nx>length</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>calculatePieceSize</span><span class=p>(</span><span class=nx>index</span><span class=p>)</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=w>    </span><span class=nx>workQueue</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=o>&amp;</span><span class=nx>pieceWork</span><span class=p>{</span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>hash</span><span class=p>,</span><span class=w> </span><span class=nx>length</span><span class=p>}</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=p>}</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=c1>// Start workers</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=k>for</span><span class=w> </span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>peer</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Peers</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=w>    </span><span class=k>go</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>startDownloadWorker</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span><span class=w> </span><span class=nx>workQueue</span><span class=p>,</span><span class=w> </span><span class=nx>results</span><span class=p>)</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=p>}</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=c1>// Collect results into a buffer until full</span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=nx>buf</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>Length</span><span class=p>)</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=nx>donePieces</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=mi>0</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=k>for</span><span class=w> </span><span class=nx>donePieces</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nb>len</span><span class=p>(</span><span class=nx>t</span><span class=p>.</span><span class=nx>PieceHashes</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=w>    </span><span class=nx>res</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>results</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>    </span><span class=nx>begin</span><span class=p>,</span><span class=w> </span><span class=nx>end</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>calculateBoundsForPiece</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>index</span><span class=p>)</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=w>    </span><span class=nb>copy</span><span class=p>(</span><span class=nx>buf</span><span class=p>[</span><span class=nx>begin</span><span class=p>:</span><span class=nx>end</span><span class=p>],</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>buf</span><span class=p>)</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a><span class=w>    </span><span class=nx>donePieces</span><span class=o>++</span>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=p>}</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=nb>close</span><span class=p>(</span><span class=nx>workQueue</span><span class=p>)</span>
</span></code></pre></div> <p>我们将为从跟踪器接收到的每个对等点生成一个 Worker goroutine。它将连接并与对等体握手，然后开始从 workQueue 中检索工作，尝试下载工作，并通过结果通道发送下载的工作。</p> <p><a class=glightbox href=../../../../2024/11/images/image-10.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-10.png></a></p> <div class="language-go highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>t</span><span class=w> </span><span class=o>*</span><span class=nx>Torrent</span><span class=p>)</span><span class=w> </span><span class=nx>startDownloadWorker</span><span class=p>(</span><span class=nx>peer</span><span class=w> </span><span class=nx>peers</span><span class=p>.</span><span class=nx>Peer</span><span class=p>,</span><span class=w> </span><span class=nx>workQueue</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>pieceWork</span><span class=p>,</span><span class=w> </span><span class=nx>results</span><span class=w> </span><span class=kd>chan</span><span class=w> </span><span class=o>*</span><span class=nx>pieceResult</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>    </span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>client</span><span class=p>.</span><span class=nx>New</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>PeerID</span><span class=p>,</span><span class=w> </span><span class=nx>t</span><span class=p>.</span><span class=nx>InfoHash</span><span class=p>)</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Could not handshake with %s. Disconnecting\n&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>peer</span><span class=p>.</span><span class=nx>IP</span><span class=p>)</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=w>        </span><span class=k>return</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Conn</span><span class=p>.</span><span class=nx>Close</span><span class=p>()</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Completed handshake with %s\n&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>peer</span><span class=p>.</span><span class=nx>IP</span><span class=p>)</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>SendUnchoke</span><span class=p>()</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>SendInterested</span><span class=p>()</span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>pw</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>workQueue</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nx>Bitfield</span><span class=p>.</span><span class=nx>HasPiece</span><span class=p>(</span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=w>            </span><span class=nx>workQueue</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>pw</span><span class=w> </span><span class=c1>// Put piece back on the queue</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>            </span><span class=k>continue</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>        </span><span class=c1>// Download the piece</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=w>        </span><span class=nx>buf</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>attemptDownloadPiece</span><span class=p>(</span><span class=nx>c</span><span class=p>,</span><span class=w> </span><span class=nx>pw</span><span class=p>)</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=w>            </span><span class=nx>log</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Exiting&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=w>            </span><span class=nx>workQueue</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>pw</span><span class=w> </span><span class=c1>// Put piece back on the queue</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a><span class=w>            </span><span class=k>return</span>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>checkIntegrity</span><span class=p>(</span><span class=nx>pw</span><span class=p>,</span><span class=w> </span><span class=nx>buf</span><span class=p>)</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>            </span><span class=nx>log</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Piece #%d failed integrity check\n&quot;</span><span class=p>,</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>)</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=w>            </span><span class=nx>workQueue</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=nx>pw</span><span class=w> </span><span class=c1>// Put piece back on the queue</span>
</span><span id=__span-14-31><a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a><span class=w>            </span><span class=k>continue</span>
</span><span id=__span-14-32><a id=__codelineno-14-32 name=__codelineno-14-32 href=#__codelineno-14-32></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-14-33><a id=__codelineno-14-33 name=__codelineno-14-33 href=#__codelineno-14-33></a>
</span><span id=__span-14-34><a id=__codelineno-14-34 name=__codelineno-14-34 href=#__codelineno-14-34></a><span class=w>        </span><span class=nx>c</span><span class=p>.</span><span class=nx>SendHave</span><span class=p>(</span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>)</span>
</span><span id=__span-14-35><a id=__codelineno-14-35 name=__codelineno-14-35 href=#__codelineno-14-35></a><span class=w>        </span><span class=nx>results</span><span class=w> </span><span class=o>&lt;-</span><span class=w> </span><span class=o>&amp;</span><span class=nx>pieceResult</span><span class=p>{</span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>buf</span><span class=p>}</span>
</span><span id=__span-14-36><a id=__codelineno-14-36 name=__codelineno-14-36 href=#__codelineno-14-36></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-14-37><a id=__codelineno-14-37 name=__codelineno-14-37 href=#__codelineno-14-37></a><span class=p>}</span>
</span></code></pre></div> <h4 id=_10>管理状态</h4> <p>我们将在一个结构体中跟踪每个对等点，并在读取信息时修改该结构体。它将包括我们从对等点下载了多少信息、我们向对等点请求了多少信息以及我们是否被掐断等数据。如果我们想进一步扩展，可以将其形式化为有限状态机。不过，现在有一个结构体和一个开关就足够了。</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=kd>type</span><span class=w> </span><span class=nx>pieceProgress</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>    </span><span class=nx>index</span><span class=w>      </span><span class=kt>int</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=nx>client</span><span class=w>     </span><span class=o>*</span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=nx>buf</span><span class=w>        </span><span class=p>[]</span><span class=kt>byte</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=nx>downloaded</span><span class=w> </span><span class=kt>int</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=nx>requested</span><span class=w>  </span><span class=kt>int</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=nx>backlog</span><span class=w>    </span><span class=kt>int</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=p>}</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>state</span><span class=w> </span><span class=o>*</span><span class=nx>pieceProgress</span><span class=p>)</span><span class=w> </span><span class=nx>readMessage</span><span class=p>()</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>    </span><span class=nx>msg</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>Read</span><span class=p>()</span><span class=w> </span><span class=c1>// this call blocks</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=nx>msg</span><span class=p>.</span><span class=nx>ID</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>MsgUnchoke</span><span class=p>:</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>        </span><span class=nx>state</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>Choked</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>false</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>MsgChoke</span><span class=p>:</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>        </span><span class=nx>state</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>Choked</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=kc>true</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>MsgHave</span><span class=p>:</span>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>        </span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>ParseHave</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=w>        </span><span class=nx>state</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>Bitfield</span><span class=p>.</span><span class=nx>SetPiece</span><span class=p>(</span><span class=nx>index</span><span class=p>)</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>MsgPiece</span><span class=p>:</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=w>        </span><span class=nx>n</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>message</span><span class=p>.</span><span class=nx>ParsePiece</span><span class=p>(</span><span class=nx>state</span><span class=p>.</span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>buf</span><span class=p>,</span><span class=w> </span><span class=nx>msg</span><span class=p>)</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=w>        </span><span class=nx>state</span><span class=p>.</span><span class=nx>downloaded</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>n</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a><span class=w>        </span><span class=nx>state</span><span class=p>.</span><span class=nx>backlog</span><span class=o>--</span>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=p>}</span>
</span></code></pre></div> <h4 id=time-to-make-requests>Time to make requests!</h4> <p>文件、片段和片段哈希值并不是全部，我们还可以进一步将片段分解为块。区块是片段的一部分，我们可以通过它所在片段的索引、片段内的字节偏移量和长度来完全定义一个区块。当我们向对等程序请求数据时，实际上就是在请求数据块。一个数据块通常有 16KB 大，这意味着一个 256 KB 的数据块实际上可能需要 16 次请求。</p> <p>如果对等设备收到一个大于 16KB 的数据块请求，它们就会切断连接。不过，根据我的经验，它们通常完全乐意满足最大 128KB 的请求。我在使用更大的数据块时，总体速度只得到了适度的提升，因此最好还是遵守规范。</p> <h4 id=_11>流水线</h4> <p>网络往返的成本很高，逐个请求每个区块绝对会降低我们的下载性能。因此，我们必须对请求进行管道化处理，以保持一定数量的未完成请求的持续压力。这可以将我们连接的吞吐量提高一个数量级。</p> <p><a class=glightbox href=../../../../2024/11/images/image-11.png data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt src=../../../../2024/11/images/image-11.png></a></p> <p>通常，BitTorrent 客户端会保留一个包含五个管道请求的队列，这也是我要使用的值。我发现增加队列大小可使下载速度提高一倍。较新的客户端使用自适应队列大小，以更好地适应现代网络速度和条件。这绝对是一个值得调整的参数，也是未来性能优化的低悬点。</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// MaxBlockSize is the largest number of bytes a request can ask for</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kd>const</span><span class=w> </span><span class=nx>MaxBlockSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>16384</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=c1>// MaxBacklog is the number of unfulfilled requests a client can have in its pipeline</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=kd>const</span><span class=w> </span><span class=nx>MaxBacklog</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>5</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=kd>func</span><span class=w> </span><span class=nx>attemptDownloadPiece</span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span><span class=w> </span><span class=nx>pw</span><span class=w> </span><span class=o>*</span><span class=nx>pieceWork</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>    </span><span class=nx>state</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>pieceProgress</span><span class=p>{</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>        </span><span class=nx>index</span><span class=p>:</span><span class=w>  </span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>,</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>        </span><span class=nx>client</span><span class=p>:</span><span class=w> </span><span class=nx>c</span><span class=p>,</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>        </span><span class=nx>buf</span><span class=p>:</span><span class=w>    </span><span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>length</span><span class=p>),</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>    </span><span class=c1>// Setting a deadline helps get unresponsive peers unstuck.</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>    </span><span class=c1>// 30 seconds is more than enough time to download a 262 KB piece</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>    </span><span class=nx>c</span><span class=p>.</span><span class=nx>Conn</span><span class=p>.</span><span class=nx>SetDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Now</span><span class=p>().</span><span class=nx>Add</span><span class=p>(</span><span class=mi>30</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>))</span>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>Conn</span><span class=p>.</span><span class=nx>SetDeadline</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Time</span><span class=p>{})</span><span class=w> </span><span class=c1>// Disable the deadline</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>downloaded</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=w>        </span><span class=c1>// If unchoked, send requests until we have enough unfulfilled requests</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nx>Choked</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>backlog</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>MaxBacklog</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>requested</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=w>                </span><span class=nx>blockSize</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>MaxBlockSize</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a><span class=w>                </span><span class=c1>// Last block might be shorter than the typical block</span>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>length</span><span class=o>-</span><span class=nx>state</span><span class=p>.</span><span class=nx>requested</span><span class=w> </span><span class=p>&lt;</span><span class=w> </span><span class=nx>blockSize</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=w>                    </span><span class=nx>blockSize</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>pw</span><span class=p>.</span><span class=nx>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>requested</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a><span class=w>                </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>SendRequest</span><span class=p>(</span><span class=nx>pw</span><span class=p>.</span><span class=nx>index</span><span class=p>,</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>requested</span><span class=p>,</span><span class=w> </span><span class=nx>blockSize</span><span class=p>)</span>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=w>                </span><span class=nx>state</span><span class=p>.</span><span class=nx>backlog</span><span class=o>++</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=w>                </span><span class=nx>state</span><span class=p>.</span><span class=nx>requested</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=nx>blockSize</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a>
</span><span id=__span-16-38><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=w>        </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>readMessage</span><span class=p>()</span>
</span><span id=__span-16-39><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-40><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span>
</span><span id=__span-16-41><a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-16-42><a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-16-43><a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a>
</span><span id=__span-16-44><a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>state</span><span class=p>.</span><span class=nx>buf</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span>
</span><span id=__span-16-45><a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a><span class=p>}</span>
</span></code></pre></div> <h4 id=maingo>main.go</h4> <p>这个很短。我们快到了</p> <div class="language-go highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=kn>package</span><span class=w> </span><span class=nx>main</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=kn>import</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>    </span><span class=s>&quot;log&quot;</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>    </span><span class=s>&quot;os&quot;</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=w>    </span><span class=s>&quot;github.com/veggiedefender/torrent-client/torrentfile&quot;</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=p>)</span>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=kd>func</span><span class=w> </span><span class=nx>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>    </span><span class=nx>inPath</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=w>    </span><span class=nx>outPath</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>    </span><span class=nx>tf</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>torrentfile</span><span class=p>.</span><span class=nx>Open</span><span class=p>(</span><span class=nx>inPath</span><span class=p>)</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>tf</span><span class=p>.</span><span class=nx>DownloadToFile</span><span class=p>(</span><span class=nx>outPath</span><span class=p>)</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=p>}</span>
</span></code></pre></div> <h2 id=_12>这并不是故事的全部</h2> <p>为了简洁起见，我只包含了一些重要的代码片段。值得注意的是，我省略了所有胶水代码、解析、单元测试以及构建特性的无聊部分。如果你感兴趣，可以查看我的<a href=https://github.com/veggiedefender/torrent-client>完整实现</a>。</p> <form class=md-feedback name=feedback hidden> <fieldset> <legend class=md-feedback__title> 此页面有帮助吗？ </legend> <div class=md-feedback__inner> <div class=md-feedback__list> <button class="md-feedback__icon md-icon" type=submit title=此页面很有帮助。 data-md-value=1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg> </button> <button class="md-feedback__icon md-icon" type=submit title=此页面可以改进。 data-md-value=0> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg> </button> </div> <div class=md-feedback__note> <div data-md-value=1 hidden> 感谢您的反馈! </div> <div data-md-value=0 hidden> 感谢您的反馈！使用我们的<a href=... target=_blank rel=noopener>反馈表</a>帮助我们改进此页面。 </div> </div> </div> </fieldset> </form> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../../10/16/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 本轮牛市的风险与机会"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> 本轮牛市的风险与机会 </div> </div> </a> <a href=../23/ class="md-footer__link md-footer__link--next" aria-label="下一页: 用不到 100 行 Go 语言构建自己的容器"> <div class=md-footer__title> <span class=md-footer__direction> 下一页 </span> <div class=md-ellipsis> 用不到 100 行 Go 语言构建自己的容器 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2018 - 2024 Cloaks <a href=https://beian.miit.gov.cn/ target=_blank>晋ICP备19014927号-3</a><br> <span id=busuanzi_container_site_pv> 本站总访问量<span id=busuanzi_value_site_pv></span>次 </span> | <span id=busuanzi_container_site_uv> 本站访客数<span id=busuanzi_value_site_uv></span>人次 </span> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://cloaks.cn/feed_rss_created.xml target=_blank rel=noopener title=cloaks.cn class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24zM3.291 17.415a3.3 3.3 0 0 1 3.293 3.295A3.303 3.303 0 0 1 3.283 24C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295M15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91"/></svg> </a> <a href=https://github.com/cloakscn target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://hub.docker.com/u/cloaks target=_blank rel=noopener title=hub.docker.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1zm0-204.3h-66.1v60.7h66.1zm78.2 144.8H362v59.4h66.1zm-156.3-72.1h-66.1v60.1h66.1zm78.1 0h-66.1v60.1h66.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1zm78.1 0h-66.1v59.4h66.1zm-78.1-72.1h-66.1v60.1h66.1z"/></svg> </a> <a href=mailto:cloaks@qq.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2"/></svg> </a> <a href="https://analytics.google.com/analytics/web/#/p299634585/reports/intelligenthome?params=_u..nav%3Dmaui" target=_blank rel=noopener title=analytics.google.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M15.86 4.39v15c0 1.67 1.14 2.61 2.39 2.61 1.14 0 2.39-.79 2.39-2.61V4.5c0-1.54-1.14-2.5-2.39-2.5s-2.39 1.06-2.39 2.39M9.61 12v7.39C9.61 21.07 10.77 22 12 22c1.14 0 2.39-.79 2.39-2.61v-7.28c0-1.54-1.14-2.5-2.39-2.5S9.61 10.67 9.61 12m-3.86 5.23c1.32 0 2.39 1.07 2.39 2.38a2.39 2.39 0 1 1-4.78 0c0-1.31 1.07-2.38 2.39-2.38"/></svg> </a> <a href=https://www.google.com/adsense/new/u/0/pub-3907145727941275/onboarding target=_blank rel=noopener title=www.google.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M22.056 8.447a3.894 3.894 0 0 0-5.313 1.419l-3.889 6.72a3.874 3.874 0 0 0 1.415 5.293l.01.005a3.894 3.894 0 0 0 5.312-1.42l3.889-6.718a3.875 3.875 0 0 0-1.416-5.294zm-14.7 12.168c-1.08 1.888-3.514 2.583-5.384 1.493S-.561 18.653.519 16.765s3.494-2.586 5.365-1.496 2.554 3.457 1.474 5.344m4.131-19.228a3.94 3.94 0 0 0-3.267 2.189l-3.67 6.279a5 5 0 0 0-.227.387l-2.746 4.737c1.345-.86 3.09-.993 4.55-.143a4.46 4.46 0 0 1 2.22 4.041l2.77-4.763q.123-.186.224-.385l3.67-6.281a3.86 3.86 0 0 0-1.283-5.55 3.96 3.96 0 0 0-2.24-.511z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent | Cookie 同意</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better. <br> 我们使用 cookie 来识别您的重复访问和偏好，并衡量我们文档的有效性以及用户是否找到了他们正在搜索的内容。经您同意，您正在帮助我们改进我们的文档。</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">同意</button> <label class=md-button for=__settings>管理设定</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"base": "../../../../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.footnote.tooltips", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.path", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <!-- Add scripts that need to run before here --> <script src=../../../../../assets/javascripts/bundle.5090c770.min.js></script> <script src=../../../../../assets/javascripts/katex.js></script> <script src=../../../../../assets/javascripts/mermaid.js></script> <script src=https://cdn.jsdelivr.net/npm/mermaid@11.3.0/dist/mermaid.min.js></script> <script src=https://unpkg.com/katex@0/dist/katex.min.js></script> <script src=https://unpkg.com/katex@0/dist/contrib/auto-render.min.js></script> <!-- Add scripts that need to run afterwards here --> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3907145727941275" crossorigin=anonymous></script> <script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>