---
date: 2024-11-13
authors:
  - cloaks
# categories:
#   - é«˜çº§æ¶æ„å¸ˆ
tags:
  - ç¿»è¯‘
draft: true
---

# ä½¿ç”¨ Go å®ç° BitTorrent å®¢æˆ·ç«¯

> åŸæ–‡åœ°å€ï¼š[https://blog.jse.li/posts/torrent/](https://blog.jse.li/posts/torrent/)

BitTorrent æ˜¯ä¸€ä¸ªé€šè¿‡ç½‘ç»œä¸‹è½½å’Œåˆ†å‘æ–‡ä»¶çš„åè®®ã€‚ä¸ä¼ ç»Ÿçš„å®¢æˆ·ç«¯/æœåŠ¡å™¨å…³ç³»ç›¸æ¯”ï¼Œä¸‹è½½è€…è¿æ¥åˆ°ä¸­å¤®æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼šåœ¨ Netflix ä¸Šè§‚çœ‹ç”µå½±ï¼Œæˆ–åŠ è½½æ‚¨æ­£åœ¨é˜…è¯»çš„ç½‘é¡µï¼‰ï¼ŒBitTorrent ç½‘ç»œä¸­çš„å‚ä¸è€…ï¼ˆç§°ä¸ºå¯¹ç­‰ç‚¹ï¼‰ä¸‹è½½å½¼æ­¤ä¹‹é—´çš„æ–‡ä»¶ç‰‡æ®µâ€”â€”è¿™å°±æ˜¯å®ƒæˆä¸ºç‚¹å¯¹ç‚¹åè®®çš„åŸå› ã€‚æˆ‘ä»¬å°†ç ”ç©¶å…¶å·¥ä½œåŸç†ï¼Œå¹¶æ„å»ºæˆ‘ä»¬è‡ªå·±çš„å®¢æˆ·ç«¯ï¼Œè¯¥å®¢æˆ·ç«¯å¯ä»¥æ‰¾åˆ°åŒè¡Œå¹¶åœ¨å®ƒä»¬ä¹‹é—´äº¤æ¢æ•°æ®ã€‚

![](images/image.png)

## å¯»æ‰¾å¯¹ç­‰ç½‘ç»œ

è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬æƒ³ç”¨ BitTorrent ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªç‚¹å¯¹ç‚¹åè®®ï¼Œæˆ‘ä»¬ä¸çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å¯¹ç­‰ç‚¹æ¥ä¸‹è½½å®ƒã€‚è¿™å¾ˆåƒæ¬åˆ°ä¸€ä¸ªæ–°åŸå¸‚å¹¶è¯•å›¾ç»“äº¤æœ‹å‹â€”â€”ä¹Ÿè®¸æˆ‘ä»¬ä¼šå»å½“åœ°çš„é…’å§æˆ–èšä¼šå°ç»„ï¼

åƒè¿™æ ·çš„é›†ä¸­ä½ç½®æ˜¯è·Ÿè¸ªå™¨èƒŒåçš„é‡è¦ç†å¿µï¼Œè·Ÿè¸ªå™¨æ˜¯ç›¸äº’ä»‹ç»å¯¹ç­‰ç‚¹çš„ä¸­å¤®æœåŠ¡å™¨ã€‚å®ƒä»¬åªæ˜¯é€šè¿‡ HTTP* è¿è¡Œçš„ Web æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥åœ¨ http://bttracker.debian.org:6969/ æ‰¾åˆ° Debianã€‚

![](images/image-1.png)

å½“ç„¶ï¼Œå¦‚æœè¿™äº›ä¸­å¤®æœåŠ¡å™¨ä¿ƒè¿›åŒè¡Œäº¤æ¢éæ³•å†…å®¹ï¼Œå®ƒä»¬å¾ˆå¯èƒ½ä¼šå—åˆ°è”é‚¦æ”¿åºœçš„è¢­å‡»ã€‚æ‚¨å¯èƒ½è¿˜è®°å¾—è¯»è¿‡æœ‰å…³ TorrentSpyã€Popcorn Time å’Œ KickassTorrents ç­‰è·Ÿè¸ªå™¨è¢«æŸ¥å°å’Œå…³é—­çš„ä¿¡æ¯ã€‚æ–°æ–¹æ³•é€šè¿‡ä½¿å¯¹ç­‰å‘ç°æˆä¸ºä¸€ä¸ªåˆ†å¸ƒå¼è¿‡ç¨‹æ¥æ¶ˆé™¤ä¸­é—´äººã€‚æˆ‘ä»¬ä¸ä¼šå®æ–½å®ƒä»¬ï¼Œä½†å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæ‚¨å¯ä»¥ç ”ç©¶ä¸€äº›æœ¯è¯­ï¼ŒåŒ…æ‹¬ DHTã€PEX å’Œç£åŠ›é“¾æ¥ã€‚

## è§£æ .torrent æ–‡ä»¶

.torrent æ–‡ä»¶æè¿°äº† torrent æ–‡ä»¶çš„å†…å®¹ä»¥åŠç”¨äºè¿æ¥åˆ°è·Ÿè¸ªå™¨çš„ä¿¡æ¯ã€‚è¿™å°±æ˜¯æˆ‘ä»¬å¯åŠ¨ torrent ä¸‹è½½è¿‡ç¨‹æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚ Debian çš„ .torrent æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

``` plain
d8:announce41:http://bttracker.debian.org:6969/announce7:comment35:"Debian CD from cdimage.debian.org"13:creation datei1573903810e9:httpseedsl145:https://cdimage.debian.org/cdimage/release/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.iso145:https://cdimage.debian.org/cdimage/archive/10.2.0//srv/cdbuilder.debian.org/dst/deb-cd/weekly-builds/amd64/iso-cd/debian-10.2.0-amd64-netinst.isoe4:infod6:lengthi351272960e4:name31:debian-10.2.0-amd64-netinst.iso12:piece lengthi262144e6:pieces26800:ï¿½ï¿½ï¿½ï¿½ï¿½PSï¿½^ï¿½ï¿½ (binary blob of the hashes of each piece)ee
```

è¿™äº›æ··ä¹±çš„å†…å®¹ä»¥ä¸€ç§åä¸º Bencodeï¼ˆå‘éŸ³ä¸º bee-encodeï¼‰çš„æ ¼å¼è¿›è¡Œç¼–ç ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œè§£ç ã€‚

Bencode å¯ä»¥ç¼–ç ä¸ JSON å¤§è‡´ç›¸åŒç±»å‹çš„ç»“æ„ï¼šå­—ç¬¦ä¸²ã€æ•´æ•°ã€åˆ—è¡¨å’Œå­—å…¸ã€‚ Bencoded æ•°æ®ä¸åƒ JSON é‚£æ ·äººç±»å¯è¯»/å¯å†™ï¼Œä½†å®ƒå¯ä»¥æœ‰æ•ˆåœ°å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶ä¸”ä»æµä¸­è§£æéå¸¸ç®€å•ã€‚å­—ç¬¦ä¸²å¸¦æœ‰é•¿åº¦å‰ç¼€ï¼Œçœ‹èµ·æ¥åƒ 4:spamã€‚æ•´æ•°ä½äºå¼€å§‹æ ‡è®°å’Œç»“æŸæ ‡è®°ä¹‹é—´ï¼Œå› æ­¤ 7 å°†ç¼–ç ä¸º i7eã€‚åˆ—è¡¨å’Œå­—å…¸çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼šl4:spami7ee è¡¨ç¤º ['spam', 7]ï¼Œè€Œ d4:spami7ee è¡¨ç¤º {spam: 7}ã€‚

åœ¨æ›´æ¼‚äº®çš„æ ¼å¼ä¸­ï¼Œæˆ‘ä»¬çš„ .torrent æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```plain
d
  8:announce
    41:http://bttracker.debian.org:6969/announce
  7:comment
    35:"Debian CD from cdimage.debian.org"
  13:creation date
    i1573903810e
  4:info
    d
      6:length
        i351272960e
      4:name
        31:debian-10.2.0-amd64-netinst.iso
      12:piece length
        i262144e
      6:pieces
        26800:ï¿½ï¿½ï¿½ï¿½ï¿½PSï¿½^ï¿½ï¿½ (binary blob of the hashes of each piece)
    e
e
```

åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°è·Ÿè¸ªå™¨çš„ URLã€åˆ›å»ºæ—¥æœŸï¼ˆä½œä¸º Unix æ—¶é—´æˆ³ï¼‰ã€æ–‡ä»¶çš„åç§°å’Œå¤§å°ï¼Œä»¥åŠåŒ…å«æ¯ä¸ªç‰‡æ®µçš„ SHA-1 å“ˆå¸Œå€¼çš„å¤§äºŒè¿›åˆ¶ blobï¼Œå®ƒä»¬åŒæ ·æ˜¯ï¼šæˆ‘ä»¬è¦ä¸‹è½½çš„æ–‡ä»¶çš„å¤§å°éƒ¨åˆ†ã€‚æ¯ä¸ªç§å­æ–‡ä»¶çš„ç¡®åˆ‡å¤§å°å„ä¸ç›¸åŒï¼Œä½†é€šå¸¸åœ¨ 256KB åˆ° 1MB ä¹‹é—´ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªå¤§æ–‡ä»¶å¯èƒ½ç”±æ•°åƒä¸ªéƒ¨åˆ†ç»„æˆã€‚æˆ‘ä»¬å°†ä»åŒè¡Œé‚£é‡Œä¸‹è½½è¿™äº›ç‰‡æ®µï¼Œæ ¹æ®æˆ‘ä»¬çš„ torrent æ–‡ä»¶ä¸­çš„å“ˆå¸Œå€¼æ£€æŸ¥å®ƒä»¬ï¼Œå°†å®ƒä»¬ç»„è£…åœ¨ä¸€èµ·ï¼Œç„¶åï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªæ–‡ä»¶ï¼

![](images/image-2.png)

è¿™ç§æœºåˆ¶ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨è¿›è¡Œè¿‡ç¨‹ä¸­éªŒè¯æ¯ä¸ªéƒ¨åˆ†çš„å®Œæ•´æ€§ã€‚å®ƒä½¿ BitTorrent èƒ½å¤ŸæŠµå¾¡æ„å¤–æŸåæˆ–æ•…æ„ torrent ä¸­æ¯’ã€‚é™¤éæ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡åŸåƒæ”»å‡»ç ´å SHA-1ï¼Œå¦åˆ™æˆ‘ä»¬å°†å‡†ç¡®è·å¾—æˆ‘ä»¬æ‰€è¦æ±‚çš„å†…å®¹ã€‚

ç¼–å†™ä¸€ä¸ª Bencode è§£æå™¨çœŸçš„å¾ˆæœ‰è¶£ï¼Œä½†è§£æä¸æ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹ã€‚ä½†æˆ‘å‘ç° Fredrik Lundh çš„ 50 è¡Œè§£æå™¨ç‰¹åˆ«å…·æœ‰å¯å‘æ€§ã€‚å¯¹äºè¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä½¿ç”¨äº† github.com/jackpal/bencode-goï¼š

```go title="bencode.go"
import (
    "github.com/jackpal/bencode-go"
)

type bencodeInfo struct {
    Pieces      string `bencode:"pieces"`
    PieceLength int    `bencode:"piece length"`
    Length      int    `bencode:"length"`
    Name        string `bencode:"name"`
}

type bencodeTorrent struct {
    Announce string      `bencode:"announce"`
    Info     bencodeInfo `bencode:"info"`
}

// Open parses a torrent file
func Open(r io.Reader) (*bencodeTorrent, error) {
    bto := bencodeTorrent{}
    err := bencode.Unmarshal(r, &bto)
    if err != nil {
        return nil, err
    }
    return &bto, nil
}
```

å› ä¸ºæˆ‘å–œæ¬¢ä¿æŒç»“æ„ç›¸å¯¹å¹³å¦ï¼Œå¹¶ä¸”å–œæ¬¢å°†åº”ç”¨ç¨‹åºç»“æ„ä¸åºåˆ—åŒ–ç»“æ„åˆ†å¼€ï¼Œæ‰€ä»¥æˆ‘å¯¼å‡ºäº†ä¸€ä¸ªä¸åŒçš„ã€æ›´å¹³å¦çš„ç»“æ„ï¼Œåä¸º TorrentFileï¼Œå¹¶ç¼–å†™äº†ä¸€äº›è¾…åŠ©å‡½æ•°æ¥åœ¨ä¸¤è€…ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘å°†ç‰‡æ®µï¼ˆä»¥å‰æ˜¯å­—ç¬¦ä¸²ï¼‰åˆ†å‰²æˆå“ˆå¸Œå€¼ç‰‡æ®µï¼ˆæ¯ä¸ª [20] å­—èŠ‚ï¼‰ï¼Œä»¥ä¾¿ç¨åå¯ä»¥è½»æ¾è®¿é—®å„ä¸ªå“ˆå¸Œå€¼ã€‚æˆ‘è¿˜è®¡ç®—äº†æ•´ä¸ªç¼–ç ä¿¡æ¯å­—å…¸ï¼ˆåŒ…å«åç§°ã€å¤§å°å’Œç‰‡æ®µå“ˆå¸Œå€¼çš„å­—å…¸ï¼‰çš„ SHA-1 å“ˆå¸Œå€¼ã€‚æˆ‘ä»¬å°†å…¶ç§°ä¸º infohashï¼Œå½“æˆ‘ä»¬ä¸è·Ÿè¸ªå™¨å’Œå¯¹ç­‰ç‚¹å¯¹è¯æ—¶ï¼Œå®ƒå”¯ä¸€åœ°æ ‡è¯†æ–‡ä»¶ã€‚ç¨åä¼šè¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ã€‚

![](images/image-3.png)

```go
type TorrentFile struct {
    Announce    string
    InfoHash    [20]byte
    PieceHashes [][20]byte
    PieceLength int
    Length      int
    Name        string
}

func (bto bencodeTorrent) toTorrentFile() (TorrentFile, error) {
// â€¦
}
```

## ä»è·Ÿè¸ªå™¨æ£€ç´¢å¯¹ç­‰ç‚¹

ç°åœ¨æˆ‘ä»¬æœ‰äº†æœ‰å…³æ–‡ä»¶åŠå…¶è·Ÿè¸ªå™¨çš„ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬ä¸è·Ÿè¸ªå™¨äº¤è°ˆä»¥å®£å¸ƒæˆ‘ä»¬ä½œä¸ºå¯¹ç­‰ç‚¹çš„å­˜åœ¨å¹¶æ£€ç´¢å…¶ä»–å¯¹ç­‰ç‚¹çš„åˆ—è¡¨ã€‚æˆ‘ä»¬åªéœ€è¦å‘ .torrent æ–‡ä»¶ä¸­æä¾›çš„å…¬å‘Š URL å‘å‡º GET è¯·æ±‚ï¼Œå¹¶å¸¦æœ‰ä¸€äº›æŸ¥è¯¢å‚æ•°ï¼š

```go
func (t *TorrentFile) buildTrackerURL(peerID [20]byte, port uint16) (string, error) {
    base, err := url.Parse(t.Announce)
    if err != nil {
        return "", err
    }
    params := url.Values{
        "info_hash":  []string{string(t.InfoHash[:])},
        "peer_id":    []string{string(peerID[:])},
        "port":       []string{strconv.Itoa(int(Port))},
        "uploaded":   []string{"0"},
        "downloaded": []string{"0"},
        "compact":    []string{"1"},
        "left":       []string{strconv.Itoa(t.Length)},
    }
    base.RawQuery = params.Encode()
    return base.String(), nil
}
```

é‡è¦çš„ï¼š

* info_hashï¼šæ ‡è¯†æˆ‘ä»¬å°è¯•ä¸‹è½½çš„æ–‡ä»¶ã€‚è¿™æ˜¯æˆ‘ä»¬ä¹‹å‰æ ¹æ®ç¼–ç åçš„ä¿¡æ¯å­—å…¸è®¡ç®—å‡ºçš„ä¿¡æ¯å“ˆå¸Œå€¼ã€‚è·Ÿè¸ªå™¨å°†ä½¿ç”¨å®ƒæ¥ç¡®å®šè¦å‘æˆ‘ä»¬å±•ç¤ºå“ªäº›å¯¹ç­‰ç‚¹ã€‚

* peer_idï¼šä¸€ä¸ª 20 å­—èŠ‚çš„åç§°ï¼Œç”¨äºå‘è·Ÿè¸ªå™¨å’Œå¯¹ç­‰ç‚¹æ ‡è¯†æˆ‘ä»¬è‡ªå·±ã€‚æˆ‘ä»¬å°†ä¸ºæ­¤ç”Ÿæˆ 20 ä¸ªéšæœºå­—èŠ‚ã€‚çœŸæ­£çš„ BitTorrent å®¢æˆ·ç«¯å…·æœ‰ç±»ä¼¼ -TR2940-k8hj0wgej6ch çš„ IDï¼Œç”¨äºæ ‡è¯†å®¢æˆ·ç«¯è½¯ä»¶å’Œç‰ˆæœ¬ - åœ¨æœ¬ä¾‹ä¸­ï¼ŒTR2940 ä»£è¡¨ Transmission å®¢æˆ·ç«¯ 2.94ã€‚

![](images/image-4.png)