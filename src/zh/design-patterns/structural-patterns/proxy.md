---
title: ä»£ç†æ¨¡å¼
date: 2023-02-25 17:18:47
sticky: 10
toc: 3
---

**ä»£ç†æ¨¡å¼**æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ è®©ä½ èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“æˆ–å…¶å ä½ç¬¦ã€‚ ä»£ç†æ§åˆ¶ç€å¯¹äºåŸå¯¹è±¡çš„è®¿é—®ï¼Œ å¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¤„ç†ã€‚

## é€»è¾‘ç»“æ„

<div style="display: flex; flex-direction: row; justify-content: center; zoom: 60%; float: right">
<div>

![](https://refactoringguru.cn/images/patterns/diagrams/proxy/structure-indexed-2x.png)
</div>
</div>

1. **æœåŠ¡æ¥å£** ï¼ˆService Interfaceï¼‰ å£°æ˜äº†æœåŠ¡æ¥å£ã€‚ ä»£ç†å¿…é¡»éµå¾ªè¯¥æ¥å£æ‰èƒ½ä¼ªè£…æˆæœåŠ¡å¯¹è±¡ã€‚
2. **æœåŠ¡** ï¼ˆServiceï¼‰ ç±»æä¾›äº†ä¸€äº›å®ç”¨çš„ä¸šåŠ¡é€»è¾‘ã€‚
3. **ä»£ç†** ï¼ˆProxyï¼‰ ç±»åŒ…å«ä¸€ä¸ªæŒ‡å‘æœåŠ¡å¯¹è±¡çš„å¼•ç”¨æˆå‘˜å˜é‡ã€‚ ä»£ç†å®Œæˆå…¶ä»»åŠ¡ ï¼ˆä¾‹å¦‚å»¶è¿Ÿåˆå§‹åŒ–ã€ è®°å½•æ—¥å¿—ã€ è®¿é—®æ§åˆ¶å’Œç¼“å­˜ç­‰ï¼‰ åä¼šå°†è¯·æ±‚ä¼ é€’ç»™æœåŠ¡å¯¹è±¡ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ ä»£ç†ä¼šå¯¹å…¶æœåŠ¡å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚
4. **å®¢æˆ·ç«¯** ï¼ˆClientï¼‰ èƒ½é€šè¿‡åŒä¸€æ¥å£ä¸æœåŠ¡æˆ–ä»£ç†è¿›è¡Œäº¤äº’ï¼Œ æ‰€ä»¥ä½ å¯åœ¨ä¸€åˆ‡éœ€è¦æœåŠ¡å¯¹è±¡çš„ä»£ç ä¸­ä½¿ç”¨ä»£ç†ã€‚

## åº”ç”¨åœºæ™¯

* **å»¶è¿Ÿåˆå§‹åŒ–** ï¼ˆè™šæ‹Ÿä»£ç†ï¼‰ã€‚ å¦‚æœä½ æœ‰ä¸€ä¸ªå¶å°”ä½¿ç”¨çš„é‡é‡çº§æœåŠ¡å¯¹è±¡ï¼Œ ä¸€ç›´ä¿æŒè¯¥å¯¹è±¡è¿è¡Œä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºæ—¶ï¼Œ å¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚

    ä½ æ— éœ€åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±åˆ›å»ºè¯¥å¯¹è±¡ï¼Œ å¯å°†å¯¹è±¡çš„åˆå§‹åŒ–å»¶è¿Ÿåˆ°çœŸæ­£æœ‰éœ€è¦çš„æ—¶å€™ã€‚

* **è®¿é—®æ§åˆ¶** ï¼ˆä¿æŠ¤ä»£ç†ï¼‰ã€‚ å¦‚æœä½ åªå¸Œæœ›ç‰¹å®šå®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡å¯¹è±¡ï¼Œ è¿™é‡Œçš„å¯¹è±¡å¯ä»¥æ˜¯æ“ä½œç³»ç»Ÿä¸­éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼Œ è€Œå®¢æˆ·ç«¯åˆ™æ˜¯å„ç§å·²å¯åŠ¨çš„ç¨‹åº ï¼ˆåŒ…æ‹¬æ¶æ„ç¨‹åºï¼‰ï¼Œ æ­¤æ—¶å¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚

    ä»£ç†å¯ä»…åœ¨å®¢æˆ·ç«¯å‡­æ®æ»¡è¶³è¦æ±‚æ—¶å°†è¯·æ±‚ä¼ é€’ç»™æœåŠ¡å¯¹è±¡ã€‚

* **æœ¬åœ°æ‰§è¡Œè¿œç¨‹æœåŠ¡** ï¼ˆè¿œç¨‹ä»£ç†ï¼‰ã€‚ é€‚ç”¨äºæœåŠ¡å¯¹è±¡ä½äºè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æƒ…å½¢ã€‚

    åœ¨è¿™ç§æƒ…å½¢ä¸­ï¼Œ ä»£ç†é€šè¿‡ç½‘ç»œä¼ é€’å®¢æˆ·ç«¯è¯·æ±‚ï¼Œ è´Ÿè´£å¤„ç†æ‰€æœ‰ä¸ç½‘ç»œç›¸å…³çš„å¤æ‚ç»†èŠ‚ã€‚

* **è®°å½•æ—¥å¿—è¯·æ±‚** ï¼ˆæ—¥å¿—è®°å½•ä»£ç†ï¼‰ã€‚ é€‚ç”¨äºå½“ä½ éœ€è¦ä¿å­˜å¯¹äºæœåŠ¡å¯¹è±¡çš„è¯·æ±‚å†å²è®°å½•æ—¶ã€‚

    ä»£ç†å¯ä»¥åœ¨å‘æœåŠ¡ä¼ é€’è¯·æ±‚å‰è¿›è¡Œè®°å½•ã€‚

* **ç¼“å­˜è¯·æ±‚ç»“æœ** ï¼ˆç¼“å­˜ä»£ç†ï¼‰ã€‚ é€‚ç”¨äºéœ€è¦ç¼“å­˜å®¢æˆ·è¯·æ±‚ç»“æœå¹¶å¯¹ç¼“å­˜ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†æ—¶ï¼Œ ç‰¹åˆ«æ˜¯å½“è¿”å›ç»“æœçš„ä½“ç§¯éå¸¸å¤§æ—¶ã€‚

    ä»£ç†å¯å¯¹é‡å¤è¯·æ±‚æ‰€éœ€çš„ç›¸åŒç»“æœè¿›è¡Œç¼“å­˜ï¼Œ è¿˜å¯ä½¿ç”¨è¯·æ±‚å‚æ•°ä½œä¸ºç´¢å¼•ç¼“å­˜çš„é”®å€¼ã€‚

* **æ™ºèƒ½å¼•ç”¨**ã€‚ å¯åœ¨æ²¡æœ‰å®¢æˆ·ç«¯ä½¿ç”¨æŸä¸ªé‡é‡çº§å¯¹è±¡æ—¶ç«‹å³é”€æ¯è¯¥å¯¹è±¡ã€‚

ä»£ç†ä¼šå°†æ‰€æœ‰è·å–äº†æŒ‡å‘æœåŠ¡å¯¹è±¡æˆ–å…¶ç»“æœçš„å®¢æˆ·ç«¯è®°å½•åœ¨æ¡ˆã€‚ ä»£ç†ä¼šæ—¶ä¸æ—¶åœ°éå†å„ä¸ªå®¢æˆ·ç«¯ï¼Œ æ£€æŸ¥å®ƒä»¬æ˜¯å¦ä»åœ¨è¿è¡Œã€‚ å¦‚æœç›¸åº”çš„å®¢æˆ·ç«¯åˆ—è¡¨ä¸ºç©ºï¼Œ ä»£ç†å°±ä¼šé”€æ¯è¯¥æœåŠ¡å¯¹è±¡ï¼Œ é‡Šæ”¾åº•å±‚ç³»ç»Ÿèµ„æºã€‚

ä»£ç†è¿˜å¯ä»¥è®°å½•å®¢æˆ·ç«¯æ˜¯å¦ä¿®æ”¹äº†æœåŠ¡å¯¹è±¡ã€‚ å…¶ä»–å®¢æˆ·ç«¯è¿˜å¯ä»¥å¤ç”¨æœªä¿®æ”¹çš„å¯¹è±¡ã€‚

## å®ç°æ–¹å¼

Nginx è¿™æ ·çš„ Web æœåŠ¡å™¨å¯å……å½“åº”ç”¨ç¨‹åºæœåŠ¡å™¨çš„ä»£ç†ï¼š

* æä¾›äº†å¯¹åº”ç”¨ç¨‹åºæœåŠ¡å™¨çš„å—æ§è®¿é—®æƒé™ã€‚
* å¯é™åˆ¶é€Ÿåº¦ã€‚
* å¯ç¼“å­˜è¯·æ±‚ã€‚

1. å¦‚æœæ²¡æœ‰ç°æˆçš„æœåŠ¡æ¥å£ï¼Œ ä½ å°±éœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£æ¥å®ç°ä»£ç†å’ŒæœåŠ¡å¯¹è±¡çš„å¯äº¤æ¢æ€§ã€‚ ä»æœåŠ¡ç±»ä¸­æŠ½å–æ¥å£å¹¶éæ€»æ˜¯å¯è¡Œçš„ï¼Œ å› ä¸ºä½ éœ€è¦å¯¹æœåŠ¡çš„æ‰€æœ‰å®¢æˆ·ç«¯è¿›è¡Œä¿®æ”¹ï¼Œ è®©å®ƒä»¬ä½¿ç”¨æ¥å£ã€‚ å¤‡é€‰è®¡åˆ’æ˜¯å°†ä»£ç†ä½œä¸ºæœåŠ¡ç±»çš„å­ç±»ï¼Œ è¿™æ ·ä»£ç†å°±èƒ½ç»§æ‰¿æœåŠ¡çš„æ‰€æœ‰æ¥å£äº†ã€‚
2. åˆ›å»ºä»£ç†ç±»ï¼Œ å…¶ä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªå­˜å‚¨æŒ‡å‘æœåŠ¡çš„å¼•ç”¨çš„æˆå‘˜å˜é‡ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œ ä»£ç†è´Ÿè´£åˆ›å»ºæœåŠ¡å¹¶å¯¹å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚ åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œ å®¢æˆ·ç«¯ä¼šé€šè¿‡æ„é€ å‡½æ•°å°†æœåŠ¡ä¼ é€’ç»™ä»£ç†ã€‚

    ```go ğŸ“„nginx.go: ä»£ç†
    package main

    type Nginx struct {
        application       *Application
        maxAllowedRequest int
        rateLimiter       map[string]int
    }

    func newNginxServer() *Nginx {
        return &Nginx{
            application:       &Application{},
            maxAllowedRequest: 2,
            rateLimiter:       make(map[string]int),
        }
    }

    func (n *Nginx) handleRequest(url, method string) (int, string) {
        allowed := n.checkRateLimiting(url)
        if !allowed {
            return 403, "Not Allowed"
        }
        return n.application.handleRequest(url, method)
    }

    func (n *Nginx) checkRateLimiting(url string) bool {
        if n.rateLimiter[url] == 0 {
            n.rateLimiter[url] = 1
        }
        if n.rateLimiter[url] > n.maxAllowedRequest {
            return false
        }
        n.rateLimiter[url] = n.rateLimiter[url] + 1
        return true
    }
    ```

3. æ ¹æ®éœ€æ±‚å®ç°ä»£ç†æ–¹æ³•ã€‚ åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ ä»£ç†åœ¨å®Œæˆä¸€äº›ä»»åŠ¡ååº”å°†å·¥ä½œå§”æ´¾ç»™æœåŠ¡å¯¹è±¡ã€‚

    ```go ğŸ“„server.go: ä¸»ä½“
    package main

    type server interface {
        handleRequest(string, string) (int, string)
    }
    ```

    ```go ğŸ“„application.go: çœŸå®ä¸»ä½“
    package main

    type Application struct {
    }

    func (a *Application) handleRequest(url, method string) (int, string) {
        if url == "/app/status" && method == "GET" {
            return 200, "Ok"
        }

        if url == "/create/user" && method == "POST" {
            return 201, "User Created"
        }
        return 404, "Not Ok"
    }
    ```

4. å¯ä»¥è€ƒè™‘æ–°å»ºä¸€ä¸ªæ„å»ºæ–¹æ³•æ¥åˆ¤æ–­å®¢æˆ·ç«¯å¯è·å–çš„æ˜¯ä»£ç†è¿˜æ˜¯å®é™…æœåŠ¡ã€‚ ä½ å¯ä»¥åœ¨ä»£ç†ç±»ä¸­åˆ›å»ºä¸€ä¸ªç®€å•çš„é™æ€æ–¹æ³•ï¼Œ ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å·¥å‚æ–¹æ³•ã€‚
5. å¯ä»¥è€ƒè™‘ä¸ºæœåŠ¡å¯¹è±¡å®ç°å»¶è¿Ÿåˆå§‹åŒ–ã€‚

```go ğŸ“„main.go: å®¢æˆ·ç«¯ä»£ç 
package main

import "fmt"

func main() {

    nginxServer := newNginxServer()
    appStatusURL := "/app/status"
    createuserURL := "/create/user"

    httpCode, body := nginxServer.handleRequest(appStatusURL, "GET")
    fmt.Printf("\nUrl: %s\nHttpCode: %d\nBody: %s\n", appStatusURL, httpCode, body)

    httpCode, body = nginxServer.handleRequest(appStatusURL, "GET")
    fmt.Printf("\nUrl: %s\nHttpCode: %d\nBody: %s\n", appStatusURL, httpCode, body)

    httpCode, body = nginxServer.handleRequest(appStatusURL, "GET")
    fmt.Printf("\nUrl: %s\nHttpCode: %d\nBody: %s\n", appStatusURL, httpCode, body)

    httpCode, body = nginxServer.handleRequest(createuserURL, "POST")
    fmt.Printf("\nUrl: %s\nHttpCode: %d\nBody: %s\n", appStatusURL, httpCode, body)

    httpCode, body = nginxServer.handleRequest(createuserURL, "GET")
    fmt.Printf("\nUrl: %s\nHttpCode: %d\nBody: %s\n", appStatusURL, httpCode, body)
}
```

```go ğŸ“„output.txt: æ‰§è¡Œç»“æœ
Url: /app/status
HttpCode: 200
Body: Ok

Url: /app/status
HttpCode: 200
Body: Ok

Url: /app/status
HttpCode: 403
Body: Not Allowed

Url: /app/status
HttpCode: 201
Body: User Created

Url: /app/status
HttpCode: 404
Body: Not Ok
```

## ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹                                                                    | ç¼ºç‚¹                                      |
| ----------------------------------------------------------------------- | ----------------------------------------- |
| ä½ å¯ä»¥åœ¨å®¢æˆ·ç«¯æ¯«æ— å¯Ÿè§‰çš„æƒ…å†µä¸‹æ§åˆ¶æœåŠ¡å¯¹è±¡ã€‚                            | ä»£ç å¯èƒ½ä¼šå˜å¾—å¤æ‚ï¼Œ å› ä¸ºéœ€è¦æ–°å»ºè®¸å¤šç±»ã€‚ |
| å¦‚æœå®¢æˆ·ç«¯å¯¹æœåŠ¡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œ ä½ å¯ä»¥å¯¹ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚ | æœåŠ¡å“åº”å¯èƒ½ä¼šå»¶è¿Ÿã€‚                      |
| å³ä½¿æœåŠ¡å¯¹è±¡è¿˜æœªå‡†å¤‡å¥½æˆ–ä¸å­˜åœ¨ï¼Œ ä»£ç†ä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚                   |                                           |
| å¼€é—­åŸåˆ™ã€‚ ä½ å¯ä»¥åœ¨ä¸å¯¹æœåŠ¡æˆ–å®¢æˆ·ç«¯åšå‡ºä¿®æ”¹çš„æƒ…å†µä¸‹åˆ›å»ºæ–°ä»£ç†ã€‚         |                                           |

## ä¸å…¶ä»–æ¨¡å¼çš„å…³ç³»

* **é€‚é…å™¨æ¨¡å¼**èƒ½ä¸ºè¢«å°è£…å¯¹è±¡æä¾›ä¸åŒçš„æ¥å£ï¼Œ **ä»£ç†æ¨¡å¼**èƒ½ä¸ºå¯¹è±¡æä¾›ç›¸åŒçš„æ¥å£ï¼Œ **è£…é¥°æ¨¡å¼**åˆ™èƒ½ä¸ºå¯¹è±¡æä¾›åŠ å¼ºçš„æ¥å£ã€‚
* **å¤–è§‚æ¨¡å¼**ä¸**ä»£ç†**çš„ç›¸ä¼¼ä¹‹å¤„åœ¨äºå®ƒä»¬éƒ½ç¼“å­˜äº†ä¸€ä¸ªå¤æ‚å®ä½“å¹¶è‡ªè¡Œå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚ *ä»£ç†*ä¸å…¶æœåŠ¡å¯¹è±¡éµå¾ªåŒä¸€æ¥å£ï¼Œ ä½¿å¾—è‡ªå·±å’ŒæœåŠ¡å¯¹è±¡å¯ä»¥äº’æ¢ï¼Œ åœ¨è¿™ä¸€ç‚¹ä¸Šå®ƒä¸*å¤–è§‚*ä¸åŒã€‚
* **è£…é¥°**å’Œ**ä»£ç†**æœ‰ç€ç›¸ä¼¼çš„ç»“æ„ï¼Œ ä½†æ˜¯å…¶æ„å›¾å´éå¸¸ä¸åŒã€‚ è¿™ä¸¤ä¸ªæ¨¡å¼çš„æ„å»ºéƒ½åŸºäºç»„åˆåŸåˆ™ï¼Œ ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå¯¹è±¡åº”è¯¥å°†éƒ¨åˆ†å·¥ä½œå§”æ´¾ç»™å¦ä¸€ä¸ªå¯¹è±¡ã€‚ ä¸¤è€…ä¹‹é—´çš„ä¸åŒä¹‹å¤„åœ¨äºä»£ç†é€šå¸¸è‡ªè¡Œç®¡ç†å…¶æœåŠ¡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œ è€Œè£…é¥°çš„ç”Ÿæˆåˆ™æ€»æ˜¯ç”±å®¢æˆ·ç«¯è¿›è¡Œæ§åˆ¶ã€‚
